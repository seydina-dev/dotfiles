#!/bin/sh
# senflix: Search and stream series (French)
# Dependencies: pup, curl, aria2c (or webtorrent)

[ ! -d "$HOME/.cache/senflix" ] && mkdir -p "$HOME/.cache/senflix"

MENU="sys-menu"
BASEURL="https://www.oxtorrent.co"
CACHEDIR="$HOME/.cache/senflix"

main(){
    if [ -z "$1" ]; then
        query=$(echo "" | sys-menu "Recherche Torrent:")
    else
        query="$1"
    fi
    
    [ -z "$query" ] && exit 0
    query=$(echo "$query" | sed 's/ /-/g')
    
    curl -s "$BASEURL/recherche/series-francaise/$query" > "$CACHEDIR/resp.html"
    
    if ! command -v pup >/dev/null; then
        echo "Error: 'pup' is required for scraping."
        exit 1
    fi

    pup 'table.table a text{}' < "$CACHEDIR/resp.html" > "$CACHEDIR/titles.txt"
    [ ! -s "$CACHEDIR/titles.txt" ] && notify-send "ðŸ˜” No Result found." && exit

    pup 'table.table td:nth-child(2) text{}' < "$CACHEDIR/resp.html" | awk '{print NR " - ["$0"]"}' > "$CACHEDIR/sizes.txt"
    pup 'table.table a attr{href}' < "$CACHEDIR/resp.html" > "$CACHEDIR/links.txt"
    
    SELECTED_LINE=$(paste -d\  "$CACHEDIR/sizes.txt" "$CACHEDIR/titles.txt" | $MENU "Select Torrent:" | cut -d\- -f1 | tr -d ' ')
    [ -z "$SELECTED_LINE" ] && exit 0
    
    DL_PAGE_URL="$BASEURL$(sed -n "${SELECTED_LINE}p" "$CACHEDIR/links.txt")"
    MAGNET=$(curl -s "$DL_PAGE_URL" | pup 'div.btn-magnet a attr{href}' | awk -F'&' '{print $1}')
    
    if [ -n "$MAGNET" ]; then
        echo "$MAGNET" | sys-clip
        notify-send "Magnet copied to clipboard"
        aria2c -s 16 -x 16 -d ~/media/Series "$MAGNET"
    else
        notify-send "Error: Could not find magnet link."
    fi
}

main "$1"
